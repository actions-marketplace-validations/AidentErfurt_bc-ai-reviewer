name: "Business Central AI Code Reviewer (Continue + MCP)"
description: "Run an AI-powered, Business Central specific code review on a Pull Request using OpenAI, Azure OpenAI or OpenRouter.ai."
branding:
  icon:  'package'
  color: 'orange'
author: "Aident GmbH"
version: "2.0.0"

inputs:
  GITHUB_TOKEN:
    description: "GitHub token with repo-scope"
    required: true
    type: string

  # Continue Models
  MODELS_BLOCK:
    description: "Multiline YAML to replace the built-in models block (use secrets for apiKey values). This input is REQUIRED and will fully replace the action's embedded models: section."
    required: true
    type: string

  # Review behaviour
  APPROVE_REVIEWS:
    description: "Let the bot approve / request-changes (based on AI output 'suggestedAction')"
    type: boolean
    default: false
  MAX_COMMENTS:
    description: "Max inline comments to post (0 = unlimited; GitHub caps single PR at 1000)."
    type: number
    default: 10

  # Context customization
  PROJECT_CONTEXT:
    description: "Architecture / guidelines text"
    type: string
    default: ""

  CONTEXT_FILES:
    description: "Comma-separated globs fetched for context"
    type: string
    default: ""

  INCLUDE_PATTERNS:
    description: "Comma-separated globs to include in review (default: AL files)"
    type: string
    default: "**/*.al"

  EXCLUDE_PATTERNS:
    description: "Comma-separated globs to exclude"
    type: string
    default: ""

  # Fetch linked issues (optional context)
  ISSUE_COUNT:
    description: "Max linked issues to fetch (0 = all)"
    type: number
    default: 0
  FETCH_CLOSED_ISSUES:
    description: "Include closed issues as context"
    type: boolean
    default: true

  # App autodiscovery
  AUTO_DETECT_APPS:
    description: "Enable automatic app.json discovery"
    type: boolean
    default: true
  INCLUDE_APP_PERMISSIONS:
    description: "Include *.PermissionSet.al / *.Entitlement.al from each app"
    type: boolean
    default: true
  INCLUDE_APP_MARKDOWN:
    description: "Include *.md files from each app"
    type: boolean
    default: true

  # Prompt style
  BASE_PROMPT_EXTRA:
    description: "Free-form text injected into the reviewers prompt (optional)"
    type: string
    default: ""

  DEBUG_PAYLOAD:
    description: "When true, prints the full JSON payload (continue_input.json) to the Actions log in a collapsible group. Use for debugging only; can be large and may expose secrets."
    type: boolean
    default: false

  SNIPPET_CONTEXT_LINES:
    description: "Number of context lines to include around each changed line when building rich snippets"
    type: number
    default: 12

runs:
  using: composite
  steps:
    - name: Setup Node.js (v20)
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install helpers parse-diff
      shell: pwsh
      working-directory: ${{ github.action_path }}
      run: |      
        npm install --no-save parse-diff@latest

    - name: Install Continue CLI
      shell: pwsh
      run: |      
        npm i -g @continuedev/cli

    # (Optional) Install uv so Serena MCP can be launched by Continue if your config uses uvx
    - name: Install uv (for Serena MCP, optional)
      shell: bash
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh || true
        echo "$HOME/.local/bin" >> $GITHUB_PATH || true

    - name: Run AI Code Review (Continue + MCP)
      shell: pwsh
      env:
        GITHUB_TOKEN:                 ${{ inputs.GITHUB_TOKEN || github.token }}
        MODELS_BLOCK:                 ${{ inputs.MODELS_BLOCK }}
      run: |
        $params = @{
          GitHubToken           = "${{ inputs.GITHUB_TOKEN || github.token }}"
          MaxComments           = [int]"${{ inputs.MAX_COMMENTS }}"
          ProjectContext        = "${{ inputs.PROJECT_CONTEXT }}"
          ContextFiles          = "${{ inputs.CONTEXT_FILES }}"
          IncludePatterns       = "${{ inputs.INCLUDE_PATTERNS }}"
          ExcludePatterns       = "${{ inputs.EXCLUDE_PATTERNS }}"
          IssueCount            = [int]"${{ inputs.ISSUE_COUNT }}"
          FetchClosedIssues     = [bool]::Parse("${{ inputs.FETCH_CLOSED_ISSUES }}")
          AutoDetectApps        = [bool]::Parse("${{ inputs.AUTO_DETECT_APPS }}")
          IncludeAppPermissions = [bool]::Parse("${{ inputs.INCLUDE_APP_PERMISSIONS }}")
          IncludeAppMarkdown    = [bool]::Parse("${{ inputs.INCLUDE_APP_MARKDOWN }}")
          BasePromptExtra       = "${{ inputs.BASE_PROMPT_EXTRA }}"
          SnippetContextLines   = [int]"${{ inputs.SNIPPET_CONTEXT_LINES }}"
        }
        if ("${{ inputs.APPROVE_REVIEWS }}" -eq "true") { $params.ApproveReviews = $true }
        if ("${{ inputs.DEBUG_PAYLOAD }}" -eq "true")   { $params.DebugPayload   = $true }


                # Always create merged config from MODELS_BLOCK and write to runner temp
        $mergeOut = Join-Path $env:RUNNER_TEMP 'continue-config.yaml'
        Write-Host "Creating merged config at $mergeOut from MODELS_BLOCK"
                  # The merge helper reads MODELS_BLOCK from the environment
          $env:MODELS_BLOCK = "${{ inputs.MODELS_BLOCK }}"
          & "${{ github.action_path }}/.github/actions/continue/merge-config.ps1" -out $mergeOut
          $cfgPath = $mergeOut


                        # Export CONTINUE_CONFIG for the PowerShell script to pick up
        $env:CONTINUE_CONFIG = $cfgPath

        & "${{ github.action_path }}/scripts/continue-review.ps1" @params

        # Cleanup: remove the merged config file written to the runner temp
        try {
          if (Test-Path $cfgPath) {
            Remove-Item -LiteralPath $cfgPath -Force -ErrorAction SilentlyContinue
            Write-Host "Removed merged config file at $cfgPath"
          }
          # Unset CONTINUE_CONFIG from the environment (process scope) and Env: drive
          Remove-Item Env:CONTINUE_CONFIG -ErrorAction SilentlyContinue
          [Environment]::SetEnvironmentVariable('CONTINUE_CONFIG', $null, 'Process')
        } catch {
          Write-Warning "Failed to delete merged config file: $_"
        }

